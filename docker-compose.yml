services:
  mbot:
    image: ioleksiy/moltbot-docker:latest
    user: "0:0"
    command: 
      - /bin/sh
      - -c
      - |
        # fix ownership of the two named volumes
        chown -R 1000:1000 /home/node

        # download config as node user if missing
        su node -s /bin/sh -c '
          if [ ! -f "/home/node/.clawdbot/moltbot.json" ]; then
            echo "moltbot.json not found, downloading from GitHub..."
            curl -fsSL -o "/home/node/.clawdbot/moltbot.json" \
              https://raw.githubusercontent.com/ioleksiy/docker-moltbot-cloudflare/refs/heads/main/assets/moltbot.json
            echo "moltbot.json downloaded successfully"
          fi

          exec moltbot gateway
        '
    networks:
      - mbot_net
    environment:
      - NODE_ENV=production
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - BRAVE_API_KEY=${BRAVE_API_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - GATEWAY_TOKEN=${GATEWAY_TOKEN}
      - WORKSPACE_DIR=/home/node/workspace-default
    volumes:
      - mbot_config:/home/node/.clawdbot
      - mbot_workspace:/home/node/workspace-default
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    networks:
      - mbot_net
    deploy:
      replicas: 1
      restart_policy:
        condition: any

networks:
  mbot_net:
    driver: overlay
    attachable: true

volumes:
  mbot_config:
  mbot_workspace:
