services:
  bot:
    image: ghcr.io/ioleksiy/openclaw-docker:latest
    user: "0:0"
    command: 
      - /bin/sh
      - -c
      - |
        # fix ownership of the two named volumes
        chown -R 1000:1000 /home/node

        # download config as node user if missing
        su node -s /bin/sh -c '
          if [ ! -f "/home/node/.openclaw/openclaw.json" ]; then
            echo "openclaw.json not found, downloading from GitHub..."
            curl -fsSL -o "/home/node/.openclaw/openclaw.json" \
              https://raw.githubusercontent.com/ioleksiy/openclaw-docker-stack/refs/heads/main/assets/openclaw.json
            echo "openclaw.json downloaded successfully"
          fi

          cd "/home/node/clawd"
          exec openclaw gateway
        '
    networks:
      - bot_network
    environment:
      - NODE_ENV=production
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - BRAVE_API_KEY=${BRAVE_API_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - GATEWAY_TOKEN=${GATEWAY_TOKEN}
      - WORKSPACE_DIR=/home/node/clawd
    volumes:
      - config:/home/node/.openclaw
      - main_workspace:/home/node/clawd
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    networks:
      - bot_network
    deploy:
      replicas: 1
      restart_policy:
        condition: any

networks:
  bot_network:
    driver: overlay
    attachable: true

volumes:
  config:
  main_workspace:
